<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.admin.pium.mapper.AttendanceMapper">

    <resultMap id="AttendanceResultMap" type="com.admin.pium.entity.Attendance">
        <id property="id" column="id"/>
        <result property="adminId" column="admin_id"/>
        <result property="studentId" column="student_id"/>
        <result property="attendanceDate" column="attendance_date"/>
        <result property="isPresent" column="is_present"/>
        <result property="progressMemo" column="progress_memo"/>
        <result property="absenceReason" column="absence_reason"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <insert id="insert" parameterType="com.admin.pium.entity.Attendance" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO attendance (admin_id, student_id, attendance_date, is_present, progress_memo, absence_reason)
        VALUES (#{adminId}, #{studentId}, #{attendanceDate}, #{isPresent}, #{progressMemo}, #{absenceReason})
    </insert>

    <update id="update" parameterType="com.admin.pium.entity.Attendance">
        UPDATE attendance
        SET student_id = #{studentId},
            attendance_date = #{attendanceDate},
            is_present = #{isPresent},
            progress_memo = #{progressMemo},
            absence_reason = #{absenceReason},
            updated_at = CURRENT_TIMESTAMP
        WHERE id = #{id} AND admin_id = #{adminId}
    </update>

    <delete id="deleteById">
        DELETE FROM attendance WHERE id = #{id} AND admin_id = #{adminId}
    </delete>

    <select id="findById" resultMap="AttendanceResultMap">
        SELECT * FROM attendance WHERE id = #{id} AND admin_id = #{adminId}
    </select>

    <select id="findAll" resultMap="AttendanceResultMap">
        SELECT * FROM attendance WHERE admin_id = #{adminId} ORDER BY attendance_date DESC
    </select>

    <select id="findByStudentId" resultMap="AttendanceResultMap">
        SELECT * FROM attendance WHERE admin_id = #{adminId} AND student_id = #{studentId} ORDER BY attendance_date DESC
    </select>

    <select id="findByDateRange" resultMap="AttendanceResultMap">
        SELECT * FROM attendance 
        WHERE admin_id = #{adminId} AND attendance_date BETWEEN #{startDate} AND #{endDate}
        ORDER BY attendance_date DESC
    </select>

    <select id="findByStudentIdAndDate" resultMap="AttendanceResultMap">
        SELECT * FROM attendance 
        WHERE admin_id = #{adminId} AND student_id = #{studentId} AND attendance_date = #{attendanceDate}
    </select>

    <select id="findByDate" resultMap="AttendanceResultMap">
        SELECT * FROM attendance 
        WHERE attendance_date = #{date}
        ORDER BY student_id
    </select>

</mapper>
